@page "/profile"
@inject IAccessTokenProvider TokenProvider
@inject HttpClient Http
@attribute [Authorize]

<h3>User Profile</h3>
@if (profile == null)
{
    <p>Loading...</p>
}
else
{
    <p>@profile["displayName"]</p>
    <p>@profile["userPrincipalName"]</p>
}

@code {
    private Dictionary<string, object>? profile;

    protected override async Task OnInitializedAsync()
    {
        var tokenResult = await TokenProvider.RequestAccessToken();

        if (tokenResult.TryGetToken(out var token))
        {
            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token.Value);

            profile = await Http.GetFromJsonAsync<Dictionary<string, object>>(
                "https://graph.microsoft.com/v1.0/me");
        }
    }
}
