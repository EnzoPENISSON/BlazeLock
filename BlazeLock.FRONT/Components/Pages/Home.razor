@page "/"
@attribute [Authorize]
@using BlazeLock.DbLib
@using BlazeLock.FRONT.Services
@using BlazeLock.FRONT.ViewModels
@using BlazeLock.FRONT.Components.Modals
@using System.Security.Claims
@inject HomeViewModel ViewModel
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserAPIService UserAPIService
@inject NavigationManager Nav

<PageTitle>Dashboard - BlazeLock</PageTitle>

<div class="flex-grow p-6 overflow-y-auto">
    <div class="max-w-7xl mx-auto">

        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <h2 class="text-3xl font-extrabold text-gray-800">Mes Coffres</h2>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-blue-500/30 transition-all duration-300 transform hover:-translate-y-1 flex items-center"
                    @onclick="ViewModel.OpenCreateModal">
                <i class="bi bi-plus-lg mr-2 text-lg"></i>Nouveau Coffre
            </button>
        </div>

        @if (ViewModel.IsLoading)
        {
            <div class="flex flex-col justify-center items-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-500 animate-pulse">Chargement de vos données...</p>
            </div>
        }
        else if (!ViewModel.MyCoffres.Any())
        {
            <div class="flex flex-col items-center justify-center py-20 text-center border-2 border-dashed border-gray-300 rounded-3xl bg-white/50">
                <div class="bg-gray-100 p-6 rounded-full mb-4">
                    <i class="bi bi-safe text-5xl text-gray-400"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-700 mb-2">Aucun coffre trouvé</h4>
                <p class="text-gray-500 max-w-sm">Vos secrets sont en sécurité, mais vous devez d'abord créer un coffre pour commencer.</p>
                <button class="mt-6 text-blue-600 font-semibold hover:underline" @onclick="ViewModel.OpenCreateModal">Créer maintenant &rarr;</button>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                @foreach (var coffre in ViewModel.MyCoffres)
                {
                    <CoffreCard Coffre="coffre"
                                IsUnlocked="@ViewModel.IsUnlocked(coffre.IdCoffre)"
                                OnClick="() => HandleCoffreClick(coffre)" />
                }
            </div>
        }
    </div>
</div>

<CreateCoffreModal IsVisible="@ViewModel.IsCreating"
                   ViewModel="@ViewModel"
                   OnClose="@ViewModel.CloseModals"
                   OnSubmit="@ViewModel.CreateCoffreAsync" />

<UnlockCoffreModal IsVisible="@(ViewModel.SelectedCoffre != null)"
                   ViewModel="@ViewModel"
                   OnClose="@ViewModel.CloseModals"
                   OnSubmit="UnlockWrapper" />

@code {
    private string UserName = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            UserName = user.Identity.Name ?? "Utilisateur";
            // Add email et nom en base

            var oid = user.FindFirst("oid")?.Value ?? user.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier")?.Value;
            if (Guid.TryParse(oid, out Guid userId) && !string.IsNullOrEmpty(UserName))
            {
                UtilisateurDto newUser = new UtilisateurDto
                {
                    IdUtilisateur = userId,
                    email = user.Identity.Name
                };
                _ = UserAPIService.InsertUtilisateurAsync(newUser);
            }

            await ViewModel.LoadDataAsync();
        }
    }

    private void HandleCoffreClick(CoffreDto coffre)
    {
        if (ViewModel.IsUnlocked(coffre.IdCoffre))
        {
            Nav.NavigateTo($"/coffre/{coffre.IdCoffre}");
        }
        else
        {
            ViewModel.SelectCoffreToUnlock(coffre);
        }
    }

    private async Task UnlockWrapper()
    {
        await ViewModel.UnlockSelectedAsync();
    }
}