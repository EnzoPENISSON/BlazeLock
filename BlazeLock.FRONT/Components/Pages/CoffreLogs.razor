@page "/coffre/{Id:guid}/logs"
@attribute [Authorize]
@using BlazeLock.DbLib
@using BlazeLock.FRONT.Services
@inject NavigationManager Nav
@inject ILogAPIService LogService

<PageTitle>Logs du Coffre - BlazeLock</PageTitle>

<div class="min-h-screen bg-gray-50 flex flex-col items-center p-6 font-sans">
    <div class="w-full max-w-7xl">
        <div class="flex items-center gap-4 mb-8">
            <button class="bg-white hover:bg-gray-100 text-gray-600 p-3 rounded-xl shadow-sm border border-gray-200 transition-all"
                    @onclick='() => Nav.NavigateTo($"/coffre/{Id}")'>
                <i class="bi bi-arrow-left text-lg"></i>
            </button>
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">Logs du Coffre</h1>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="flex justify-center items-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
            </div>
        }
        else if (_pagedResult == null || !_pagedResult.Items.Any())
        {
            <div class="text-center py-20 bg-white rounded-2xl shadow-sm border border-gray-100">
                <i class="bi bi-card-checklist text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-700">Aucun log trouvé</h3>
                <p class="text-gray-500">Il n'y a pas encore d'activité enregistrée pour ce coffre.</p>
            </div>
        }
        else
        {
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateur</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @foreach (var log in _pagedResult.Items)
                        {
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@log.Timestamp.ToString("g")</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@log.Texte</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@log.IdUtilisateur</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="flex items-center justify-between mt-4">
                <div>
                    <p class="text-sm text-gray-700">
                        Page @(_pagedResult.PageNumber) sur @(_pagedResult.TotalPages)
                    </p>
                </div>
                <div class="flex gap-2">
                    <button @onclick="() => ChangePage(_pagedResult.PageNumber - 1)" disabled="@(_pagedResult.PageNumber <= 1)"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Précédent
                    </button>
                    <button @onclick="() => ChangePage(_pagedResult.PageNumber + 1)" disabled="@(_pagedResult.PageNumber >= _pagedResult.TotalPages)"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Suivant
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private PagedResultDto<LogDto>? _pagedResult;
    private bool _isLoading = true;
    private int _currentPage = 1;
    private int _pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        _isLoading = true;
        try
        {
            _pagedResult = await LogService.GetLogsByVaultIdAsync(Id, _currentPage, _pageSize);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching logs: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ChangePage(int pageNumber)
    {
        if (pageNumber < 1 || (_pagedResult != null && pageNumber > _pagedResult.TotalPages))
        {
            return;
        }
        _currentPage = pageNumber;
        await LoadLogs();
    }
}