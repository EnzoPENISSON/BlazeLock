@using System.Text
@using System.Security.Cryptography

<div class="mt-2 p-3 bg-blue-100/50 border border-blue-200/50 rounded-lg">
    <div class="space-y-3">
        @if (_areOptionsVisible)
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 items-center animate-fade-in-down">
                <div class="sm:col-span-2">
                    <label for="length" class="block text-sm font-medium text-blue-800">Longueur : @_passwordLength</label>
                    <input type="range" id="length" min="8" max="64" @bind="_passwordLength" @bind:event="oninput" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" />
                </div>

                <div class="relative flex items-start">
                    <div class="flex h-6 items-center">
                        <input id="uppercase" type="checkbox" @bind="_includeUppercase" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                    </div>
                    <div class="ml-3 text-sm leading-6">
                        <label for="uppercase" class="font-medium text-blue-900">Majuscules (A-Z)</label>
                    </div>
                </div>

                <div class="relative flex items-start">
                    <div class="flex h-6 items-center">
                        <input id="numbers" type="checkbox" @bind="_includeNumbers" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                    </div>
                    <div class="ml-3 text-sm leading-6">
                        <label for="numbers" class="font-medium text-blue-900">Nombres (0-9)</label>
                    </div>
                </div>

                <div class="relative flex items-start">
                    <div class="flex h-6 items-center">
                        <input id="lowercase" type="checkbox" @bind="_includeLowercase" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                    </div>
                    <div class="ml-3 text-sm leading-6">
                        <label for="lowercase" class="font-medium text-blue-900">Minuscules (a-z)</label>
                    </div>
                </div>

                <div class="relative flex items-start">
                    <div class="flex h-6 items-center">
                        <input id="symbols" type="checkbox" @bind="_includeSymbols" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                    </div>
                    <div class="ml-3 text-sm leading-6">
                        <label for="symbols" class="font-medium text-blue-900">Symboles (!#&...)</label>
                    </div>
                </div>
            </div>
        }

        <div class="flex items-center gap-2">
            <button type="button" @onclick="GeneratePassword" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-all flex-grow flex items-center justify-center">
                <i class="bi bi-shuffle mr-2"></i> Générer
            </button>
            <button type="button" @onclick="ToggleOptions" title="Options" class="flex-shrink-0 h-9 w-9 bg-blue-200 hover:bg-blue-300 text-blue-700 font-semibold rounded-lg transition-all flex items-center justify-center">
                <i class="bi bi-sliders"></i>
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<string> OnPasswordGenerated { get; set; }

    private int _passwordLength = 16;
    private bool _includeUppercase = true;
    private bool _includeLowercase = true;
    private bool _includeNumbers = true;
    private bool _includeSymbols = true;
    private bool _areOptionsVisible = false;

    private const string UppercaseChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private const string LowercaseChars = "abcdefghijklmnopqrstuvwxyz";
    private const string NumberChars = "0123456789";
    private const string SymbolChars = "!@#$%^&*()_-+=<>?";

    private void ToggleOptions()
    {
        _areOptionsVisible = !_areOptionsVisible;
    }

    private async Task GeneratePassword()
    {
        var charSetBuilder = new StringBuilder();
        if (_includeUppercase) charSetBuilder.Append(UppercaseChars);
        if (_includeLowercase) charSetBuilder.Append(LowercaseChars);
        if (_includeNumbers) charSetBuilder.Append(NumberChars);
        if (_includeSymbols) charSetBuilder.Append(SymbolChars);

        var charSet = charSetBuilder.ToString();
        if (string.IsNullOrEmpty(charSet)) return;

        var password = new char[_passwordLength];
        var cryptoProvider = new RNGCryptoServiceProvider();

        for (int i = 0; i < _passwordLength; i++)
        {
            var uintBuffer = new byte[4];
            cryptoProvider.GetBytes(uintBuffer);
            uint num = BitConverter.ToUInt32(uintBuffer, 0);
            password[i] = charSet[(int)(num % (uint)charSet.Length)];
        }

        await OnPasswordGenerated.InvokeAsync(new string(password));
    }
}